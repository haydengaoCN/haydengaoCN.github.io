# 0 - overview

* Redis 服务器拥有多个数据库，每个数据库主要包含两个字典：键空间字典和过期字典。

* 数据库是由字典构成的，对数据库的操作是建立在对字典的操作之上；

* 数据库的键总是字符串对象，而值可以是五种字符串对象之一；

* Redis 采用惰性删除和定期删除的策略，惰性删除是碰到过期键才删除，定期删除是每隔一段时间主动删除过期键；

* 执行 *SAVE* 或者 *BGSAVE* 命令式，RDB 文件不会包含已经过期的键；

* 删除过期键时，服务器会显式的将删除命令记录到 AOF；

* 主服务器删除过期键时，会向所有的从服务器发出一条删除命令，显式删除过期键；

* 从服务器即使发现过期键，也不会自作主张直接删除；而是等待主节点的删除命令；

  这种统一 + 中心化的策略是为了保证主从数据的一致性（从服务器没有修改数据的权限）。

* 当 Redis 对数据库进行修改后，服务器会根据配置向客户端发送数据库通知。

# 1 - 服务器中的数据库

服务器中默认有16个数据库，客户端连接时默认使用 `db[0]` 数据库，可以通过 `select 1` 命令切换数据库。

```c
struct redisServer {
  redisDb *db;  // 数据库数据，保存服务器中的所有数据库；
  int dbnum;  // 服务器的数据库数目，默认有16个；
};

struct redisDb {
  dict *dict;  // 数据库键空间，保存着数据库中的所有键值对；	
  dict *expires;  // 过期字典，保存着键的过期时间；
};
```

Redis 是一个键值对数据库服务器，`redisDb` 底层是字典，保存了数据库中的所有键值对，也被称之为键空间 key space。

数据库中的键都是一个**字符串对象**，

数据库中的值可以是五种 Redis 对象：字符串对象、列表对象、哈希对象、集合对象和有序集合对象。

# 2 -  过期键与过期键的删除策略

当一个键被设置了过期时间，该键就会被加入到数据库的 `expires`字典中，字典中保存着到期时间戳。

## 2.1 相关 Redis 命令

设置过期时间：

* *EXPIRE <key> <ttl>* , 将 key 的生存时间设置为 ttl 秒；
* *PEXPIRE <key> <ttl>* , 将 key 的生存时间设置为 ttl 毫秒；
* *EXPIREAT <key> <timestamp>*，指定 key 的过期时间，精度为秒的时间戳；
* *PEXPIREAT <key> <timestamp>*，指定 key 的过期时间，精度为毫秒的时间戳；

移除过期时间：

* *PERSIST <key>* ，移除 key  的过期时间；

返回剩余生存时间：

* *TTL <key>* ，计算过期时间与当前时间的时间差；
* *PTTL <KEY>*，获取以毫秒为单位的生存时间；

## 2.2 Redis 过期键删除策略

根据删除的时机可以总结为三种不同的删除策略，实际上是对内存与 CPU 的折中：

1）定时删除（及时删除）

​	键一旦过期就立即被删除。

​	比如可以设置一个定时事件，时间一到就动手删除。

​	该策略对内存最友好，但是可能对 CPU 造成影响，导致服务器响应时间和吞吐量下降；

2）惰性删除

​	程序只会在取键的时候才会对键进行过期检查。

​	该策略对 CPU 友好，但是对内存不友好。

​	如果一个键永远没被访问，那么其实相当于内存泄漏。

3）定期删除

​	每隔一段时间执行一次过期检查操作，并且限制执行的时长和频率以减少对 CPU 的影响。

​	难点在于如何控制执行频率和执行时间。

Redis 采取了惰性删除和定期删除结合的策略：

* 惰性删除

  执行所有的读写命令之前，都必须对输入键进行检查，如果键过期则需要从数据库中删除，否则继续执行相关命令。

* 定期删除

  限定范围：每次只检查一定数量的数据库中的一定数量的键；

  限定时间：一次检查任务的执行时间如果达到上限，那么就中断任务；

  记录进度：记录下本次检查的进度，作为下次检查的起点；

# 3 - RDB、AOF 和复制功能对过期键的处理

* RDB

  生成 RDB 文件时（比如执行 *SAVE* 或者 *BGSAVE*），已过期的键不会被保存到新的 RDB 文件中。

  加载 RDB 文件时（比如启动 Redis  服务器时），主服务器忽略过期键，从服务器加载所有数据。

* AOF

  当服务器以 AOF 的模式在运行时，如果一个键到期了，但是没有被惰性删除或者定期删除，那么不会影响 AOF 文件。

  如果因为惰性删除或者定期删除导致过期键被删除，则 AOF 文件会显式的记录下 `DEL KEY`这个操作。

  AOF  重写时，已过期的键不会被保存到重写的 AOF 中。

* 复制

  当运行在复制模型下时，主服务器统一控制从服务器的删除：

  主服务器删除过期键时，会显示向所有从服务器发送 DEL 命令，告知从服务器删除这个过期键；

  从服务器接收到客户端的读请求，即使请求的键已经过期，仍正常执行命令；

