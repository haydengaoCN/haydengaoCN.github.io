# 3. 文件

## MySQL参数文件

告诉MySQL实例启动时在哪里可以找到数据库文件，并且指定某些初始化参数。

## MySQL日志文件

用来记录MySQL实例对某种条件做出响应时写入的文件。

### 错误日志

记录MySQL的启动、运行和关闭过程进行了记录。

```mysql
show variables like 'log_error';
```

### 慢查询日志

可以设置一个阈值`long_query_time`，当一条SQL语句执行时间超过$>$阈值时，这条语句将会被记录到慢查询日志。

甚至可以记录没有使用索引的SQL语句。

### 查询日志

查询日志记录了所有对MySQL数据库的所有请求的信息，无论这些请求是否得到了正确的执行。

### 二进制日志binlog

binlog记录了所有对MySQL数据库执行变更的所有操作，但是不包括SELECT和SHOW这类操作。

**二进制文件主要有以下几个作用**：

1）恢复Recovery

​	某些数据的回复需要binlog。用户可以使用binlog进行point-in-time的恢复。

2）复制Replication

​	通过复制和执行二进制文件，slave MySQL可以同步master MySQL。

3）审计audit

​	可以查看关键SQL语句。

**binlog记录的格式**：

1）STATEMENT

​	二进制文件记录的是逻辑SQL语句。这会带来主从同步的问题，比如SQL语句使用了rand,uuid函数。

2）ROW

​	在该格式下，binlog记录的是表的行更改情况。显然，binlog文件会更大，复制的网络开销也会增大。

3）MIXED

​	混合模式默认采用STATEMEMT格式，但是在某些情况下会使用ROW格式，比如采用了某些不确定函数。

**如何查看binlog**:

```bash
mysqlbinlog --start-position=203 test.000004
```



## InnoDB存储引擎文件

InnoDB存储引擎自己独有的日志文件：表空间文件和重做日志文件。

### 表空间文件tablespace file

可以指定多个路径，使得一个表被分配到不同磁盘上，提高读写效率。

### 重做日志文件redo log file

重做日志文件是InnoDB引擎的事务日志

当实例失败，比如主机断电时，重启时InnoDB存储引擎会利用重做文件恢复到掉电时的时刻，以此来保证数据的完整性。

* **重做日志文件组**

  至少2个大小相同的重做日志文件构成一个文件组；InnoDB循环写入该文件组中的重做日志文件。

* **重做日志文件大小考量**

  重做日志文件不能过大。如果设置的很大，在恢复时需要耗费较长的时间。

  但是也不能设置的过小，否则可能导致一个事务日志可能会多次切换重做日志文件，此外还会可能导致async checkpoint（这是因为容量超过重做日志文件的阈值，导致强制刷新脏页）。

* 同样是记录事务日志，重做日志与二进制日志的区别？

  1）二进制文件是属于MySQL数据库有关的日志；而重做日志是InnoDB独有的日志文件，只会记录InnoDB存储引擎的事务日志；

  2）记录内容不同。二进制文件记录的是关于一个操作的具体内容，即该日志是逻辑日志；而重做日志记录的是每个页page更改的物理情况。

  3）写入时机不同。二进制文件仅在事务提交前进行提交，即只写磁盘一次；而在事务进行过程中，不断有重做日志条目redo entry被写入到重做日志文件中。

* 重做日志写入过程

  重做日志条目结构：

  redo_log_type | space | page_no | redo_log_nody

  引擎先写到redo log buffer，然后按照一定顺序写入到磁盘重做日志文件。

  从buffer到磁盘的时机：

  1）master thread每秒都会将buffer内容写入到磁盘重做日志文件；

  2）事务commit时。行为由`InnoDB_flush_log_at_trx_commit`控制：
  	0 ： 等待主线程写入；1  ： commit时立即写入磁盘；2 ： 异步写到磁盘。

  ​	为了保证持久性，应该设置为1。

  > 系统调用函数 `write` 时，会先1）将数据拷贝到内核空间缓冲区，然后等待一定的时机再将2）内核空间缓冲区的数据刷新到磁盘。
  >
  > `InnoDB_flush_log_at_trx_commit` 为 1 表示不仅执行 `write`，还会执行 `flush`；为 2 表示只执行 `write`, `flush` 时机交由系统控制。
  
  <figure>
    <img src="mysql_innodb.assets/image-20210906160005160.png" alt="img" style="zoom: 50%;">
    <figcaption>Fig.3-1 重做日志文件写入过程。</figcaption>
  </figure>
  
  
